<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><link rel="icon" href="/images/favicon/favicon.ico"/><meta name="og:title" content="Alex Gurvich - data scientist"/><meta name="twitter:card" content="summary_large_image"/><link rel="stylesheet" href="fonts/font-awesome/css/font-awesome.min.css"/><link rel="preload" as="image" href="/images/alex-gurvich.png"/><title>GPU accelerated chemistry</title><link rel="preload" as="image" href="/images/chimes_network.png"/><meta name="next-head-count" content="9"/><link rel="preload" href="/node_blog/_next/static/css/58e9f19bfae4581b.css" as="style"/><link rel="stylesheet" href="/node_blog/_next/static/css/58e9f19bfae4581b.css" data-n-g=""/><link rel="preload" href="/node_blog/_next/static/css/81c937b40bc6530e.css" as="style"/><link rel="stylesheet" href="/node_blog/_next/static/css/81c937b40bc6530e.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/node_blog/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/node_blog/_next/static/chunks/webpack-df424aaa9266de20.js" defer=""></script><script src="/node_blog/_next/static/chunks/framework-2c79e2a64abdb08b.js" defer=""></script><script src="/node_blog/_next/static/chunks/main-31033f408f48c2a8.js" defer=""></script><script src="/node_blog/_next/static/chunks/pages/_app-2dfd096757008a0f.js" defer=""></script><script src="/node_blog/_next/static/chunks/247-900f082858a6346c.js" defer=""></script><script src="/node_blog/_next/static/chunks/358-14c60bb94e9d94b9.js" defer=""></script><script src="/node_blog/_next/static/chunks/pages/%5Bid%5D-009424e1ccc93dcb.js" defer=""></script><script src="/node_blog/_next/static/dLz1c4-pBevFPMm_Vnaym/_buildManifest.js" defer=""></script><script src="/node_blog/_next/static/dLz1c4-pBevFPMm_Vnaym/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="layout_container__fbLkO"><aside class="layout_sidebar__AY6x8"><header class="layout_header__kY0Lt"><a href="/node_blog"><img alt="" width="100" height="100" decoding="async" data-nimg="1" class="layout_profilePicture__kIjzH" style="color:transparent" src="/images/alex-gurvich.png"/></a><div class="layout_titleName__HKogh">Alex Gurvich</div><p>Former astrophysicist turned data scientist. Friend of dogs.</p></header><footer class="layout_footer__dka_2"><section><div class="contact_myh3__W6Onk"> Contact me </div><ul class="contact_list__6GU4P"><li class="contact_listItem__j7iuj"><a href="https://www.twitter.com/alexbgurvich" target="_blank"><i class="fa fa-twitter"></i></a></li><li class="contact_listItem__j7iuj"><a href="https://www.linkedin.com/in/alex-b-gurvich" target="_blank"><i class="fa fa-linkedin"></i></a></li><li class="contact_listItem__j7iuj"><a href="https://www.github.com/agurvich" target="_blank"><i class="fa fa-github"></i></a></li><li class="contact_listItem__j7iuj"><a href="mailto:alex.b.gurvich@gmail.com" target="_blank"><i class="fa fa-envelope-o"></i></a></li></ul></section><section>2023<!-- --> © <!-- -->Alex Gurvich</section></footer></aside><main class="layout_content__563Cv"><div class="post_post___H4tn"><div><img resizeMode="cover" alt="" width="1000" height="500" decoding="async" data-nimg="1" class="post_header__Y5oP6" style="color:transparent" src="/images/chimes_network.png"/><div class="post_title__aQveY">GPU accelerated chemistry</div><div class="post_date__3834l"><time dateTime="2019-06-01 00:00:00-06:00">June 1, 2019</time></div><div class="post_content__PPM5L"><h2>Let's talk about interstellar chemistry.</h2>
<p>It may not be obvious that chemistry is really important for how galaxies form and evolve, but it turns out to be a key component in determining how the instellar gas that eventually forms stars cools down and collapses into gravitationally bound clouds.
When stuff is hanging out in space, it has to lose energy to cool down and the primary way it does that is by emitting light (we call the process "radiative cooling").
The rate at which material is able to emit light and cool depends on how hot it is, how dense it is, and what the material is made up of (the chemical composition).
So when we're running these big <a href="https://fire.northwestern.edu">galaxy formation simulations</a> it's vitally important to be able to calculate the rate at which stuff cools down correctly; among other things, of course.
The chemical composition of the interstellar gas depends on how elements are transformed inside the interiors of stars (fused from Hydrogen, to Helium, to even heavier elements that astronomers refer to in bulk as "metals;" with this definition Oxygen would be a metal, weird, I know) and how those elements combine to form molecules, i.e. chemistry.</p>
<p>So, in these simulations the typical thing to do is to approximate the chemistry using tabulated chemical reaction rates and then assume the reactions have had enough time to enter a state of "chemical equilibrium" (i.e. the reactions are balanced and the state is no longer changing).
However, the time it takes for a system to enter chemical equilibrium at these temperature and densities we're simulating can be millions to billions of years-- that assumption may not, and indeed <a href="https://richings.bitbucket.io/chimes/home.html">has been showne</a> to not always be valid.
That's where "non-equilibrium" or "time-dependent" chemistry comes into the story.</p>
<h2>The problem with non-equilibrium chemistry</h2>
<p>The problem is that non-equilibrium chemistry is very computationally demanding, it takes a lot of computer effort to solve the chemical reaction equations for how much of each molecule and chemical ion there should be for a given density and temperature.
The issue isn't so much that the math is complicated, it's "only" a system of thousands of "coupled linear differential equations" referred to as a "chemical network."
A differential equation is just an equation that involves something changing with time (technically it means it has something called a derivative, which is another word for rate of change) so it makes sense considering we're talking about reaction rates.
That they're coupled just means that they depend on each other, and that they're linear means that they are simple (specifically it means no variable is raised to more than the first power-- no squares or cubes).</p>
<p>Those are important properties for a system of equations because it means that you can write them in terms of matrix operations and find solutions using linear algebra!
That the system is coupled just means that the matrix will have off diagonal elements.
So, our problem of interstellar chemistry just became a math problem of inverting and multiplying matrices-- that should be solved, right?
Well, yes, but... the problem is that we need to do this for tens of millions of independent systems (one system of equations for each particle in our simulation).
As well, for each particle, we would like to know how the chemical composition evolves over the timescale of millions of years, but the relevant timescale for the chemical rates are much shorter-- only thousands of years.
This mismatch in timescales makes our system of equations "stiff."
So, to put it another way, we need to do many millions of simply linear algebra operations that are independent of one another, a very computationally expensive task.
For some.</p>
<h2>GPUs to the rescue</h2>
<p>Graphics processing units (GPUs) were originally designed to support computer rendering tasks by determining the color of each pixel on your screen in parallel.
In the past decade GPUs have been used more and more for other purposes due to their massively parallel infrastructure.
In particular, a GPU can run many thousands of independent computation threads on a single chip though any individual thread has a relatively small throughput.
This makes them ideal for solving a huge volume of simple problems but not so good at solving one hard problem.
One thing in particular that GPUs have been used for a lot is to do linear algebra.
It turns out, linear algebra is very important for machine learning and AI as the mathematics behind both is essentially... you guessed it!
Solving systems of equations.</p>
<h2>Interstellar Chemistry with WIND CHIMES</h2>
<p>So, with all this in mind, as a 2018-2019 Blue Waters Graduate Fellow I developed a GPU accelerated version of the non-equilibrium chemistry solver <a href="https://richings.bitbucket.io/chimes/home.html">CHIMES</a>, developed by Prof. Alex Richings at University of Hull in the UK.
Alex recently coupled CHIMES to the FIRE simulation code and, when enabled, dominates up to 95% of the computational time, making it prohibitively expensive to use in already expensive high-resolution studies.
However, by offloading the chemistry calculation and integrating the equations on a GPU we hoped to be able to bring the non-equilibrium chemistry in line with the rest of the cost of the simulation.</p>
<p>To that end, I created <a href="https://github.com/agurvich/WIND">WIND</a>, a CUDA application that integrates general systems of coupled stiff differential equations.
WIND is a standalone application that takes as input specially formatted data tabulating the coefficients in each of the differential equations.
It is written in C+CUDA and implements both explicit (Runge-Kutta 4) and implicit (Semi-implicit extrapolation) differential equation integrators.
I optimized it at the kernel level using Nvidia's NSIGHT Compute profiling software.
It uses shared block memory where possible, and texture memory to store reaction rate coefficients for easy interpolation.</p>
<p>If you'd like to know more about WIND or want to talk shop about CUDA and GPUs drop me a line!</p></div></div><aside> <ul class="postGrid_tagList__1KHV3"><a href="/node_blog/tags/astronomy"><li class="postGrid_tagItem__bWBH3">#astronomy</li></a><a href="/node_blog/tags/software"><li class="postGrid_tagItem__bWBH3">#software</li></a></ul> </aside></div><div class="layout_backToHome__9sjx_"><a href="/node_blog">← Back to home</a></div></main></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"wind-chimes","contentHtml":"\u003ch2\u003eLet's talk about interstellar chemistry.\u003c/h2\u003e\n\u003cp\u003eIt may not be obvious that chemistry is really important for how galaxies form and evolve, but it turns out to be a key component in determining how the instellar gas that eventually forms stars cools down and collapses into gravitationally bound clouds.\nWhen stuff is hanging out in space, it has to lose energy to cool down and the primary way it does that is by emitting light (we call the process \"radiative cooling\").\nThe rate at which material is able to emit light and cool depends on how hot it is, how dense it is, and what the material is made up of (the chemical composition).\nSo when we're running these big \u003ca href=\"https://fire.northwestern.edu\"\u003egalaxy formation simulations\u003c/a\u003e it's vitally important to be able to calculate the rate at which stuff cools down correctly; among other things, of course.\nThe chemical composition of the interstellar gas depends on how elements are transformed inside the interiors of stars (fused from Hydrogen, to Helium, to even heavier elements that astronomers refer to in bulk as \"metals;\" with this definition Oxygen would be a metal, weird, I know) and how those elements combine to form molecules, i.e. chemistry.\u003c/p\u003e\n\u003cp\u003eSo, in these simulations the typical thing to do is to approximate the chemistry using tabulated chemical reaction rates and then assume the reactions have had enough time to enter a state of \"chemical equilibrium\" (i.e. the reactions are balanced and the state is no longer changing).\nHowever, the time it takes for a system to enter chemical equilibrium at these temperature and densities we're simulating can be millions to billions of years-- that assumption may not, and indeed \u003ca href=\"https://richings.bitbucket.io/chimes/home.html\"\u003ehas been showne\u003c/a\u003e to not always be valid.\nThat's where \"non-equilibrium\" or \"time-dependent\" chemistry comes into the story.\u003c/p\u003e\n\u003ch2\u003eThe problem with non-equilibrium chemistry\u003c/h2\u003e\n\u003cp\u003eThe problem is that non-equilibrium chemistry is very computationally demanding, it takes a lot of computer effort to solve the chemical reaction equations for how much of each molecule and chemical ion there should be for a given density and temperature.\nThe issue isn't so much that the math is complicated, it's \"only\" a system of thousands of \"coupled linear differential equations\" referred to as a \"chemical network.\"\nA differential equation is just an equation that involves something changing with time (technically it means it has something called a derivative, which is another word for rate of change) so it makes sense considering we're talking about reaction rates.\nThat they're coupled just means that they depend on each other, and that they're linear means that they are simple (specifically it means no variable is raised to more than the first power-- no squares or cubes).\u003c/p\u003e\n\u003cp\u003eThose are important properties for a system of equations because it means that you can write them in terms of matrix operations and find solutions using linear algebra!\nThat the system is coupled just means that the matrix will have off diagonal elements.\nSo, our problem of interstellar chemistry just became a math problem of inverting and multiplying matrices-- that should be solved, right?\nWell, yes, but... the problem is that we need to do this for tens of millions of independent systems (one system of equations for each particle in our simulation).\nAs well, for each particle, we would like to know how the chemical composition evolves over the timescale of millions of years, but the relevant timescale for the chemical rates are much shorter-- only thousands of years.\nThis mismatch in timescales makes our system of equations \"stiff.\"\nSo, to put it another way, we need to do many millions of simply linear algebra operations that are independent of one another, a very computationally expensive task.\nFor some.\u003c/p\u003e\n\u003ch2\u003eGPUs to the rescue\u003c/h2\u003e\n\u003cp\u003eGraphics processing units (GPUs) were originally designed to support computer rendering tasks by determining the color of each pixel on your screen in parallel.\nIn the past decade GPUs have been used more and more for other purposes due to their massively parallel infrastructure.\nIn particular, a GPU can run many thousands of independent computation threads on a single chip though any individual thread has a relatively small throughput.\nThis makes them ideal for solving a huge volume of simple problems but not so good at solving one hard problem.\nOne thing in particular that GPUs have been used for a lot is to do linear algebra.\nIt turns out, linear algebra is very important for machine learning and AI as the mathematics behind both is essentially... you guessed it!\nSolving systems of equations.\u003c/p\u003e\n\u003ch2\u003eInterstellar Chemistry with WIND CHIMES\u003c/h2\u003e\n\u003cp\u003eSo, with all this in mind, as a 2018-2019 Blue Waters Graduate Fellow I developed a GPU accelerated version of the non-equilibrium chemistry solver \u003ca href=\"https://richings.bitbucket.io/chimes/home.html\"\u003eCHIMES\u003c/a\u003e, developed by Prof. Alex Richings at University of Hull in the UK.\nAlex recently coupled CHIMES to the FIRE simulation code and, when enabled, dominates up to 95% of the computational time, making it prohibitively expensive to use in already expensive high-resolution studies.\nHowever, by offloading the chemistry calculation and integrating the equations on a GPU we hoped to be able to bring the non-equilibrium chemistry in line with the rest of the cost of the simulation.\u003c/p\u003e\n\u003cp\u003eTo that end, I created \u003ca href=\"https://github.com/agurvich/WIND\"\u003eWIND\u003c/a\u003e, a CUDA application that integrates general systems of coupled stiff differential equations.\nWIND is a standalone application that takes as input specially formatted data tabulating the coefficients in each of the differential equations.\nIt is written in C+CUDA and implements both explicit (Runge-Kutta 4) and implicit (Semi-implicit extrapolation) differential equation integrators.\nI optimized it at the kernel level using Nvidia's NSIGHT Compute profiling software.\nIt uses shared block memory where possible, and texture memory to store reaction rate coefficients for easy interpolation.\u003c/p\u003e\n\u003cp\u003eIf you'd like to know more about WIND or want to talk shop about CUDA and GPUs drop me a line!\u003c/p\u003e","layout":"post","title":"GPU accelerated chemistry","img":"chimes_network.png","tags":["software","astronomy"],"date":"2019-06-01 00:00:00-06:00"}},"__N_SSG":true},"page":"/[id]","query":{"id":"wind-chimes"},"buildId":"dLz1c4-pBevFPMm_Vnaym","assetPrefix":"/node_blog","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>